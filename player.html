<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Tennis Trivia - Squadra üéæ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="player.css">
</head>

<body>
    <!-- Join Screen -->
    <div id="join-screen" class="screen active">
        <div class="join-container">
            <div class="logo-small">
                <div class="tennis-ball-small"></div>
                <h1>Tennis Trivia</h1>
            </div>

            <div class="glass-card">
                <h2>Registra Squadra</h2>

                <div class="form-group">
                    <label for="team-name">Nome Squadra:</label>
                    <input type="text" id="team-name" placeholder="Es. I Campioni" maxlength="15" autocomplete="off">
                </div>

                <button id="join-btn" class="btn-primary">
                    <span>Entra in Gioco</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Waiting Screen -->
    <div id="waiting-screen" class="screen">
        <div class="waiting-container">
            <div class="waiting-icon">‚è≥</div>
            <h2>Squadra Pronta!</h2>
            <div class="player-info">
                <span id="player-team-display"></span>
            </div>
            <p id="waiting-text">Attendi l'inizio della partita...</p>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="game-screen" class="screen">
        <div class="game-header">
            <span class="question-counter">Domanda <span id="q-num">1</span>/<span id="q-total">15</span></span>
        </div>

        <div class="buzzer-area">
            <p class="instruction" id="instruction">Scegli la risposta!</p>

            <div id="question-display" class="question-display"></div>

            <div class="answer-buttons">
                <button class="buzz-btn" data-answer="0"><span class="btn-letter">A</span><span
                        class="btn-text"></span></button>
                <button class="buzz-btn" data-answer="1"><span class="btn-letter">B</span><span
                        class="btn-text"></span></button>
                <button class="buzz-btn" data-answer="2"><span class="btn-letter">C</span><span
                        class="btn-text"></span></button>
                <button class="buzz-btn" data-answer="3"><span class="btn-letter">D</span><span
                        class="btn-text"></span></button>
            </div>
        </div>

        <div id="feedback-overlay" class="feedback-overlay"></div>
    </div>

    <!-- Result Screen -->
    <div id="result-screen" class="screen">
        <div class="result-container">
            <div id="result-icon-player" class="result-icon-player"></div>
            <h2 id="result-message"></h2>
            <p id="result-correct-text" class="result-correct-text"></p>
            <div class="current-score">Punti: <span id="score-display">0</span></div>
        </div>
    </div>

    <!-- Victory Screen -->
    <div id="victory-screen" class="screen">
        <div class="gameover-container">
            <div class="trophy-small" style="font-size: 6rem; animation: bounce 1s infinite;">üèÜ</div>
            <h1 style="font-size: 2.5rem; color: #ffe66d;">HAI VINTO!</h1>
            <p>Sei il campione del Tennis Trivia!</p>
            <div class="confetti-container"></div>
            <button id="rejoin-btn-win" class="btn-primary" style="margin-top: 2rem;">Nuova Partita</button>
        </div>
    </div>

    <!-- Game Over Screen -->
    <div id="gameover-screen" class="screen">
        <div class="gameover-container">
            <div class="trophy-small">üèÅ</div>
            <h1>Partita Terminata!</h1>
            <p>Guarda lo schermo principale per la classifica finale</p>
            <button id="rejoin-btn" class="btn-primary">Nuova Partita</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        // State
        let myTeam = null;
        let canAnswer = false;
        let selectedAnswerIndex = null;

        // Elements
        const screens = {
            join: document.getElementById('join-screen'),
            waiting: document.getElementById('waiting-screen'),
            game: document.getElementById('game-screen'),
            result: document.getElementById('result-screen'),
            gameover: document.getElementById('gameover-screen'),
            victory: document.getElementById('victory-screen')
        };

        const joinBtn = document.getElementById('join-btn');
        const teamNameInput = document.getElementById('team-name');
        const instruction = document.getElementById('instruction');
        const feedbackOverlay = document.getElementById('feedback-overlay');
        const buzzButtons = document.querySelectorAll('.buzz-btn');

        // New Confirm Button
        const buzzerArea = document.querySelector('.buzzer-area');
        const confirmBtn = document.createElement('button');
        confirmBtn.id = 'confirm-btn';
        confirmBtn.className = 'btn-primary';
        confirmBtn.innerHTML = 'INVIA RISPOSTA üöÄ';
        confirmBtn.style.marginTop = '1.5rem';
        confirmBtn.style.display = 'none'; // Hidden until selection
        buzzerArea.appendChild(confirmBtn);

        // Listeners
        joinBtn.addEventListener('click', registerTeam);
        // Handle "New Game" as refresh for now, but explicit leave is cleaner if game is stuck
        document.getElementById('rejoin-btn').addEventListener('click', () => location.reload());

        buzzButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                if (canAnswer) {
                    const answer = parseInt(btn.dataset.answer);
                    selectAnswer(answer, btn);
                }
            });
        });

        confirmBtn.addEventListener('click', () => {
            if (canAnswer && selectedAnswerIndex !== null) {
                submitAnswer(selectedAnswerIndex);
            }
        });

        // Socket Events
        socket.on('player:registered', (team) => {
            myTeam = team;
            document.getElementById('player-team-display').textContent = team.name;
            switchScreen('waiting');
            document.body.style.setProperty('--primary', team.color);

            // Dynamically add Exit button if not present
            if (!document.getElementById('exit-btn')) {
                const exitBtn = document.createElement('div');
                exitBtn.id = 'exit-btn';
                exitBtn.style.marginTop = '2rem';
                exitBtn.style.textAlign = 'center';
                exitBtn.innerHTML = '<span style="color:#ff6b6b; border-bottom:1px solid; cursor:pointer; opacity:0.8;">‚ùå Esci dalla partita</span>';
                exitBtn.onclick = () => {
                    if (confirm('Vuoi davvero disconnetterti?')) {
                        socket.emit('player:leave');
                        location.reload();
                    }
                };
                document.querySelector('.waiting-container').appendChild(exitBtn);
            }
        });

        socket.on('game:reset', () => {
            alert('Il presentatore ha resettato la partita.');
            location.reload();
        });

        socket.on('game:started', ({ totalQuestions }) => {
            document.getElementById('q-total').textContent = totalQuestions;
            document.getElementById('waiting-text').textContent = 'La partita sta iniziando!';

            // Remove exit button when game starts to avoid accidents
            const exitBtn = document.getElementById('exit-btn');
            if (exitBtn) exitBtn.remove();
        });

        socket.on('game:question', (q) => {
            switchScreen('game');
            document.getElementById('q-num').textContent = q.index;
            document.getElementById('q-total').textContent = q.total;

            const header = document.querySelector('.game-header');
            if (q.isSpecial) {
                header.classList.add('special');
                header.innerHTML = `<div style="color:#ffd700; font-weight:800; font-size:1.2rem; margin-bottom:0.5rem;">‚òÖ DOMANDA SPECIALE X2 ‚òÖ</div>` +
                    `<span class="question-counter">Domanda <span id="q-num">${q.index}</span>/<span id="q-total">${q.total}</span></span>`;
            } else {
                header.classList.remove('special');
                header.innerHTML = `<span class="question-counter">Domanda <span id="q-num">${q.index}</span>/<span id="q-total">${q.total}</span></span>`;
            }

            // Update Question Text
            const questionDisplay = document.getElementById('question-display');
            questionDisplay.textContent = q.question;

            // Update Answer Buttons
            const btnTexts = document.querySelectorAll('.btn-text');
            if (q.answers && q.answers.length === 4) {
                btnTexts.forEach((span, idx) => {
                    span.textContent = q.answers[idx];
                });
            }

            enableAnswering();
            hideFeedback();
        });

        socket.on('player:answerReceived', () => {
            showFeedback('Risposta Inviata! Attendi...', 'waiting');
        });

        socket.on('game:result', ({ correctAnswer, correctAnswerText }) => {
            // Wait for individual feedback
        });

        socket.on('player:feedback', ({ correct, score }) => {
            const icon = document.getElementById('result-icon-player');
            const msg = document.getElementById('result-message');
            const scoreDisplay = document.getElementById('score-display');

            scoreDisplay.textContent = score;

            if (correct) {
                icon.textContent = 'üéâ';
                msg.textContent = '+10 Punti!';
                screens.result.className = 'screen active correct';
            } else {
                icon.textContent = '‚ùå';
                msg.textContent = 'Peccato!';
                screens.result.className = 'screen active wrong';
            }

            switchScreen('result');
        });

        socket.on('game:over', ({ teams }) => {
            // Find highest score
            if (teams && teams.length > 0) {
                const maxScore = teams[0].score;
                // Check if I am a winner
                const amIWinner = teams.some(t => t.id === myTeam.id && t.score === maxScore && t.score > 0);

                if (amIWinner) {
                    switchScreen('victory');
                    createConfetti();
                } else {
                    switchScreen('gameover');
                }
            } else {
                switchScreen('gameover');
            }
        });

        // Listeners for new buttons
        document.getElementById('rejoin-btn-win').addEventListener('click', () => location.reload());

        // Confetti Helper
        function createConfetti() {
            const colors = ['#fce18a', '#ff726d', '#b48def', '#f4306d'];
            const container = document.querySelector('#victory-screen .confetti-container');
            container.innerHTML = '';

            for (let i = 0; i < 50; i++) {
                const confetto = document.createElement('div');
                confetto.classList.add('confetti');
                confetto.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetto.style.left = Math.random() * 100 + '%';
                confetto.style.animationDelay = Math.random() * 2 + 's';
                container.appendChild(confetto);
            }
        }

        // ... (Rest of functions) ...

        // Functions
        function registerTeam() {
            const name = teamNameInput.value.trim();
            if (name) {
                socket.emit('player:join', name);
            }
        }

        function selectAnswer(index, btn) {
            selectedAnswerIndex = index;

            // Visual feedback
            buzzButtons.forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');

            // Show confirm
            confirmBtn.style.display = 'block';
        }

        function submitAnswer(index) {
            canAnswer = false;
            socket.emit('player:answer', index);
            confirmBtn.style.display = 'none';
        }

        function enableAnswering() {
            canAnswer = true;
            selectedAnswerIndex = null;
            confirmBtn.style.display = 'none';
            instruction.textContent = 'Scegli la risposta!';
            buzzButtons.forEach(btn => {
                btn.classList.remove('disabled', 'selected', 'correct', 'wrong');
            });
        }

        function switchScreen(name) {
            Object.values(screens).forEach(s => s.classList.remove('active'));
            screens[name].classList.add('active');
        }

        function showFeedback(text, type) {
            feedbackOverlay.textContent = text;
            feedbackOverlay.className = `feedback-overlay active ${type}`;
        }

        function hideFeedback() {
            feedbackOverlay.classList.remove('active');
        }

        // Error Handling
        socket.on('player:error', (msg) => {
            alert(msg);
        });

        // Back Button Guard
        history.pushState(null, document.title, location.href);
        window.addEventListener('popstate', function (event) {
            if (myTeam) {
                // If in game
                const leave = confirm("Vuoi davvero uscire dal gioco?");
                if (leave) {
                    socket.emit('player:leave');
                    history.back(); // Let it go back
                } else {
                    history.pushState(null, document.title, location.href); // Stay here
                }
            }
        });
    </script>
</body>

</html>