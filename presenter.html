<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tennis Trivia - Presentatore üéæ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="presenter.css">
</head>

<body>
    <!-- Setup Screen -->
    <div id="setup-screen" class="screen active">
        <div class="setup-container">
            <div class="logo-container">
                <div class="tennis-ball"></div>
                <h1>Tennis Trivia</h1>
                <p class="subtitle">Modalit√† Presentatore</p>
            </div>

            <div class="glass-card">
                <div class="players-waiting">
                    <h3>Squadre Connesse: <span id="player-count">0</span></h3>
                    <div id="players-list" class="players-list"></div>
                    <p class="waiting-hint">In attesa che le squadre si colleghino...</p>
                </div>

                <div class="questions-config">
                    <label for="num-questions">Numero domande:</label>
                    <select id="num-questions">
                        <option value="10">10</option>
                        <option value="15" selected>15</option>
                        <option value="20">20</option>
                        <option value="30">30</option>
                    </select>
                </div>

                <button id="start-game" class="btn-primary">
                    <span>Inizia il Gioco</span>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 12h14M12 5l7 7-7 7" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="game-screen" class="screen">
        <!-- Scoreboard -->
        <div id="scoreboard" class="scoreboard compact"></div>

        <!-- Question Area -->
        <div class="question-area">
            <div class="question-header">
                <span class="question-number">Domanda <span id="current-q">1</span> di <span
                        id="total-q">15</span></span>
                <span class="category-badge" id="category-badge">Categoria</span>
            </div>

            <div class="question-card glass-card">
                <h2 id="question-text">Preparati...</h2>
            </div>

            <div id="answers-container" class="answers-grid"></div>
        </div>

        <!-- Progress Bar & Timer -->
        <div class="progress-container">
            <div id="timer-display" class="timer-display">15</div> <!-- New Timer -->
            <div class="progress-text">Hanno risposto: <span id="answered-count">0</span> / <span
                    id="total-teams">0</span></div>
            <div class="progress-bar-bg">
                <div id="progress-bar" class="progress-bar-fill"></div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls" style="bottom: 40px;"> <!-- Lifted up slightly -->
            <button id="next-btn" class="btn-primary">
                <span>Mostra Risultati</span>
            </button>
        </div>
    </div>

    <!-- End Screen -->
    <div id="end-screen" class="screen">
        <div class="end-container">
            <div class="confetti-container" id="confetti"></div>
            <div class="trophy-container">
                <div class="trophy">üèÜ</div>
            </div>
            <h1>Classifica Finale!</h1>
            <div id="final-rankings" class="final-rankings glass-card"></div>
            <div class="end-buttons">
                <button id="new-game" class="btn-primary">Nuova Partita</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        // State
        let teams = [];
        let currentQuestion = null;
        let phase = 'setup';

        // Elements
        const screens = {
            setup: document.getElementById('setup-screen'),
            game: document.getElementById('game-screen'),
            end: document.getElementById('end-screen')
        };

        const nextBtn = document.getElementById('next-btn');
        const playerCount = document.getElementById('player-count');
        const playersList = document.getElementById('players-list');
        const scoreboard = document.getElementById('scoreboard');
        const answersContainer = document.getElementById('answers-container');

        // Listeners
        document.getElementById('start-game').addEventListener('click', () => {
            const num = parseInt(document.getElementById('num-questions').value);
            socket.emit('presenter:startGame', num);
        });

        // Add Terminate Button dynamically (Fixed Position Bottom Right)
        const terminateBtn = document.createElement('button');
        terminateBtn.id = 'terminate-btn';
        terminateBtn.className = 'btn-floating-danger';
        terminateBtn.innerHTML = '‚ùå Termina';
        terminateBtn.addEventListener('click', () => {
            if (confirm('Terminare la partita corrente? Tutti i progressi andranno persi.')) {
                socket.emit('presenter:resetGame');
            }
        });
        document.body.appendChild(terminateBtn);

        nextBtn.addEventListener('click', () => {
            socket.emit('presenter:next');
        });

        document.getElementById('new-game').addEventListener('click', () => {
            socket.emit('presenter:resetGame');
        });

        // Socket Events
        socket.emit('presenter:join');

        socket.on('game:reset', () => {
            location.reload();
        });

        socket.on('presenter:updateTeams', (t) => {
            teams = t;
            updateTeamsList();
            updateScoreboard();
            document.getElementById('total-teams').textContent = teams.length;
        });

        socket.on('game:started', ({ totalQuestions }) => {
            document.getElementById('total-q').textContent = totalQuestions;
            switchScreen('game');
            terminateBtn.style.display = 'block';
        });

        socket.on('game:question', (q) => {
            currentQuestion = q;
            phase = 'question';
            showQuestion(q);

            nextBtn.innerHTML = '<span>Mostra Risultati</span>';
            // Hide next button during question (auto-show results will trigger it back, or manual override)
            // User did not ask to hide it, but logic says wait for timer. 
            // However, presenter might want to skip wait. Keeping it visible.

            resetProgress();

            // Start local countdown visualization?
            // Could add a countdown bar or text later.
        });

        socket.on('game:timer', ({ timeLeft }) => {
            const timerDisplay = document.getElementById('timer-display');
            timerDisplay.textContent = timeLeft;
            timerDisplay.classList.add('active'); // Pulse animation

            // Visual countdown locally (synced roughly)
            let localTime = timeLeft;
            const interval = setInterval(() => {
                localTime--;
                if (localTime >= 0) timerDisplay.textContent = localTime;
                if (localTime <= 5) timerDisplay.classList.add('urgent');
                if (localTime <= 0) clearInterval(interval);
            }, 1000);

            // Clear interval on next question
            socket.once('game:result', () => clearInterval(interval));
        });

        socket.on('presenter:answerUpdate', ({ answered, total }) => {
            document.getElementById('answered-count').textContent = answered;
            document.getElementById('total-teams').textContent = total;
            const pct = (answered / total) * 100;
            document.getElementById('progress-bar').style.width = `${pct}%`;
        });

        socket.on('game:result', ({ correctAnswer, teams: t, roundDetails }) => {
            teams = t;
            phase = 'result';

            // Update scoreboard with results visualization
            updateScoreboard(roundDetails);
            revealAnswer(correctAnswer);

            nextBtn.innerHTML = '<span>Prossima Domanda</span> <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>';
        });

        socket.on('game:over', ({ teams: t }) => {
            teams = t;
            showEndScreen();
            terminateBtn.style.display = 'none';
        });

        // Functions
        function switchScreen(name) {
            Object.values(screens).forEach(s => s.classList.remove('active'));
            screens[name].classList.add('active');
        }

        function updateTeamsList() {
            playerCount.textContent = teams.length;
            playersList.innerHTML = teams.map(t =>
                `<div class="player-item" style="border-color:${t.color}">${escapeHtml(t.name)}</div>`
            ).join('');
        }

        function updateScoreboard(roundDetails = null) {
            scoreboard.innerHTML = '';
            teams.forEach(t => {
                const div = document.createElement('div');
                div.className = 'team-score';
                div.style.setProperty('--team-color', t.color);

                // Check result from roundDetails
                let statusIcon = '';
                let statusClass = '';

                if (roundDetails) {
                    const result = roundDetails.find(r => r.teamId === t.id);
                    if (result) {
                        if (!result.answered) {
                            statusIcon = '<span class="status-icon">‚è≥</span>'; // Dimmed/Time out
                            statusClass = 'timeout';
                        } else if (result.isCorrect) {
                            statusIcon = '<span class="status-icon">‚úÖ</span>';
                            statusClass = 'correct';
                        } else {
                            statusIcon = '<span class="status-icon">‚ùå</span>';
                            statusClass = 'wrong';
                        }
                    }
                }

                div.innerHTML = `
                    <div class="team-indicator"></div>
                    <span class="team-name">${escapeHtml(t.name)}</span>
                    <span class="team-points">${t.score}</span>
                    ${statusIcon}
                `;
                if (statusClass) div.classList.add(statusClass);

                scoreboard.appendChild(div);
            });
        }

        function showQuestion(q) {
            document.getElementById('current-q').textContent = q.index;
            document.getElementById('category-badge').textContent = q.category;

            const qt = document.getElementById('question-text');
            qt.style.animation = 'none';
            qt.offsetHeight;
            qt.style.animation = 'questionIn 0.5s ease-out';
            qt.textContent = q.question;

            answersContainer.innerHTML = '';
            const letters = ['A', 'B', 'C', 'D'];
            q.answers.forEach((ans, i) => {
                const btn = document.createElement('div');
                btn.className = 'answer-btn';
                btn.innerHTML = `<span class="answer-letter">${letters[i]}</span>${escapeHtml(ans)}`;
                answersContainer.appendChild(btn);
            });
        }

        function revealAnswer(correctIndex) {
            const buttons = answersContainer.querySelectorAll('.answer-btn');
            buttons.forEach((btn, i) => {
                if (i === correctIndex) {
                    btn.classList.add('correct');
                } else {
                    btn.classList.add('disabled');
                }
            });
        }

        function resetProgress() {
            document.getElementById('answered-count').textContent = '0';
            document.getElementById('progress-bar').style.width = '0%';
        }

        function showEndScreen() {
            switchScreen('end');
            const rankings = document.getElementById('final-rankings');
            rankings.innerHTML = '';
            const positions = ['ü•á', 'ü•à', 'ü•â'];

            teams.forEach((t, i) => {
                const div = document.createElement('div');
                div.className = 'ranking-item';
                div.innerHTML = `
                    <span class="ranking-position">${positions[i] || (i + 1) + '¬∞'}</span>
                    <span class="ranking-team">${escapeHtml(t.name)}</span>
                    <span class="ranking-score" style="color:${t.color}">${t.score}</span>
                `;
                rankings.appendChild(div);
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>

</html>